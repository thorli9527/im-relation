syntax = "proto3";

import "google/protobuf/empty.proto";
import "message.proto";

// 说明：定义好友相关的业务消息载荷（与 common/proto/socket.proto 中 MsgKind 对齐）
// - 传输层为 Protobuf + 长度前缀帧（LengthDelimitedCodec）
// - socket 层 payload 为 bytes，业务在此处定义具体子消息结构

package msg_friend_service;

// 基础枚举/类型

// 消息主类型使用 socket.MsgKind，contents 可承载完整消息体

// 与消息（状态/通话/typing/reaction）相关定义统一迁移到 message.proto

// 好友申请/关系（MK_FRIEND_REQUEST 等）

// 好友申请
message FriendRequest {
  // 好友申请ID
  int64 id = 1;
  // 申请人用户ID
  int64 from_uid = 2;
  // 被申请人用户ID
  int64 to_uid = 3;
  // 申请理由
  string reason = 4;
  // 申请来源
  .message.FriendRequestSource source = 5;
  // 申请创建时间
  int64 created_at = 6;
  // 好友别名/备注（可选）
  optional string remark = 7;
  // 申请人想展示的昵称
  optional string nickname = 8;
}

// 处理好友申请（接受/拒绝）
message FriendRequestDecision {
  // 好友申请ID
  int64 request_id = 1;
  // 是否接受
  bool accept = 2;
  // 备注（可选）
  optional string remark = 3;
  // 处理时间
  int64 decided_at = 4;
  // 审批者希望展示的昵称
  optional string nickname = 5;
}

// 删除好友
message FriendDelete {
  // 发起人用户ID
  int64 operator_uid = 1;
  // 被删除的好友用户ID
  int64 friend_uid = 2;
  // 时间
  int64 at = 3;
}

// 更新好友备注
message FriendUpdateRemark {
  // 用户ID
  int64 uid = 1;
  // 好友用户ID
  int64 friend_uid = 2;
  // 新备注
  string remark = 3;
  // 时间
  int64 updated_at = 4;
}

// 最小设备密钥 RPC（密钥托管与分发）
message IdentityKey { string curve = 1; bytes pub_key = 2; }
message SignedPreKey { uint32 key_id = 1; bytes pub_key = 2; bytes signature = 3; }
message OneTimePreKey { uint32 key_id = 1; bytes pub_key = 2; }
message UploadDeviceKeysRequest {
  int64 uid = 1;
  string device_id = 2;
  IdentityKey identity_key = 3;
  SignedPreKey signed_pre_key = 4;
  repeated OneTimePreKey one_time_pre_keys = 5;
}
message UploadDeviceKeysResponse { bool success = 1; }
message FetchDeviceKeysRequest { int64 uid = 1; }
message DeviceKeyBundle {
  int64 uid = 1;
  string device_id = 2;
  IdentityKey identity_key = 3;
  SignedPreKey signed_pre_key = 4;
  repeated OneTimePreKey one_time_pre_keys = 5;
}
message FetchDeviceKeysResponse { repeated DeviceKeyBundle bundles = 1; }

// 根据用户 ID 聚合拉取好友消息历史
message ListUserFriendMessagesRequest {
  // 当前用户 ID
  int64 uid = 1;
  // 起始时间（毫秒，闭区间）；传 0 表示不限制
  int64 since_timestamp = 2;
  // 返回的最大消息数，缺省 200
  uint32 limit = 3;
}

// 会话快照
message FriendConversationSnapshot {
  int64 owner_id = 1;
  int64 peer_id = 2;
  int64 conversation_id = 3;
  int64 last_msg_id = 4;
  int64 last_sender_id = 6;
  int64 last_receiver_id = 7;
  int64 last_timestamp = 8;
  uint32 unread_count = 9;
  int64 updated_at = 10;
  int64 created_at = 11;
}

message ListFriendConversationsRequest {
  int64 owner_id = 1;
  // 缺省 20
  uint32 limit = 2;
  // 游标分页：取 updated_at 更早的记录
  int64 before_updated_at = 3;
  // 当 updated_at 相同时按 conversation_id 继续向前翻页
  int64 before_conversation_id = 4;
}

message ListFriendConversationsResponse {
  repeated FriendConversationSnapshot snapshots = 1;
  bool has_more = 2;
}

message UpsertFriendConversationSnapshotRequest {
  FriendConversationSnapshot snapshot = 1;
}

message DeleteFriendConversationSnapshotRequest {
  int64 owner_id = 1;
  int64 conversation_id = 2;
}

// 批量下发 ProfileUpdate（昵称/头像等资料变更）
message BroadcastProfileUpdatesReq {
  int64 sender_id = 1;
  repeated int64 friend_ids = 2;
  repeated message.MessageContent contents = 3;
  // 事件时间（毫秒），缺省用服务器时间
  int64 ts_ms = 4;
  // 是否要求 ACK，缺省 false
  optional bool require_ack = 5;
}

message GetFriendRequestRequest {
  uint64 request_id = 1;
}

message GetFriendRequestResponse {
  uint64 request_id = 1;
  int64 from_uid = 2;
  int64 to_uid = 3;
  string remark = 4;
  string nickname = 5;
  string peer_remark = 6;
  string peer_nickname = 7;
  // 来源枚举，兼容老版本缺省值
  int32 source = 8;
}

// 直接接受好友（允许任何人添加）专用：创建申请并立即决策为通过。
message AddFriendAnyoneRequest {
  int64 from_uid = 1;
  int64 to_uid = 2;
  string from_reason = 3;
  string from_remark = 4;
  string from_nickname = 5;
  int32 source = 6;
  string to_remark = 7;
  string to_nickname = 8;
}

message AddFriendAnyoneResponse {
  bool ok = 1;
}

// 创建好友申请。
message AddFriendRequestCommand {
  int64 from_uid = 1;
  int64 to_uid = 2;
  string reason = 3;
  string remark = 4;
  string nickname = 5;
  int32 source = 6;
}

message AddFriendRequestResponse {
  uint64 request_id = 1;
}

// 审批好友申请。
message DecideFriendRequestCommand {
  uint64 request_id = 1;
  int64 approver_uid = 2;
  bool accept = 3;
  string remark = 4;
  string nickname = 5;
}

message DecideFriendRequestResponse {
  bool ok = 1;
}

// 好友消息服务（非群聊）
service FriendMsgService {
  // 分页查询好友间的历史消息
  rpc ListFriendMessages(message.QueryFriendMessagesRequest) returns (message.QueryMessagesResponse);
  // 聚合查询用户的好友消息
  rpc ListUserFriendMessages(ListUserFriendMessagesRequest) returns (message.QueryMessagesResponse);
  // 获取最近好友会话列表
  rpc ListFriendConversations(ListFriendConversationsRequest) returns (ListFriendConversationsResponse);
  // 更新或新增好友会话快照
  rpc UpsertFriendConversationSnapshot(UpsertFriendConversationSnapshotRequest) returns (google.protobuf.Empty);
  // 删除好友会话快照
  rpc DeleteFriendConversationSnapshot(DeleteFriendConversationSnapshotRequest) returns (google.protobuf.Empty);
  // 处理通用的好友消息域结构
  rpc HandleFriendMessage(message.DomainMessage) returns (google.protobuf.Empty);
  // 批量广播 ProfileUpdate 事件给好友
  rpc BroadcastProfileUpdates(BroadcastProfileUpdatesReq) returns (google.protobuf.Empty);
  // 查询好友申请详情
  rpc GetFriendRequest(GetFriendRequestRequest) returns (GetFriendRequestResponse);
  // 允许任何人添加：创建申请并立即决策为通过（落库并推送业务通知）。
  rpc AddFriendAnyone(AddFriendAnyoneRequest) returns (AddFriendAnyoneResponse);
  // 创建好友申请。
  rpc SubmitFriendRequest(AddFriendRequestCommand) returns (AddFriendRequestResponse);
  // 审批好友申请。
  rpc DecideFriendRequest(DecideFriendRequestCommand) returns (DecideFriendRequestResponse);
}
